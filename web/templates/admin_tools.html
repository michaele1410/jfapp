{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <h1 class="mb-4">{{ _('Admin-Werkzeuge') }}</h1>

  {# Flash-Messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="mb-3">
    {% for category, message in messages %}
    {% set bs = 'danger' if category in ['error','danger'] else (
      'warning' if category == 'warning' else (
      'success' if category == 'success' else 'info')) %}
    <div class="alert alert-{{ bs }} alert-dismissible fade show" role="alert">
      {{ message|safe }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Schließen') }}"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <div class="row g-4">
    {# ---------- Bemerkungsoptionen (volle Breite) ---------- #}
    <div class="col-12">
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>{{ _('Bemerkungsoptionen verwalten') }}</strong>
          <span class="text-muted small">{{ _('Eine Option pro Zeile') }}</span>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-start">
            <div class="col-md-5 order-2 order-md-1">
              <label class="form-label">{{ _('Aktuelle Optionen') }}</label>
              <ul class="list-group list-group-flush border rounded">
                {% for opt in current_options %}
                <li class="list-group-item py-1">{{ opt }}</li>
                {% else %}
                <li class="list-group-item text-muted">{{ _('Keine Optionen vorhanden') }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-7 order-1 order-md-2">
              <form method="post" action="{{ url_for('admin_tools') }}" class="h-100 d-flex flex-column">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="update_bemerkungen">
                <label for="options" class="form-label">{{ _('Optionen ersetzen') }}</label>
                <textarea id="options" name="options" class="form-control" rows="10"
                  placeholder="{{ _('Eine Option pro Zeile ...') }}">{{ current_options|join('\n') }}</textarea>
                <div class="mt-3 d-flex gap-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>{{ _('Speichern') }}
                  </button>
                  <button type="button" class="btn btn-outline-secondary"
                    onclick="document.getElementById('options').value='';">
                    <i class="bi bi-eraser me-1"></i>{{ _('Leeren') }}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ---------- SMTP-Test und DB-Dump nebeneinander ---------- #}
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>{{ _('SMTP-Konfiguration prüfen') }}</strong>
        </div>
        <div class="card-body">
          <p class="mb-3">
            {% if status %}
            {% set s_lower = status|string|lower %}
            {% if 'incomplete' in s_lower %}
            <span class="badge bg-danger">{{ status }}</span>
            {% else %}
            <span class="badge bg-success">{{ status }}</span>
            {% endif %}
            {% else %}
            <span class="badge bg-secondary">{{ _('Unbekannter SMTP-Status') }}</span>
            {% endif %}
          </p>
          <form method="post" action="{{ url_for('admin_tools') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="smtp">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-envelope-check me-1"></i>{{ _('Test-Mail senden') }}
            </button>
          </form>
          <small class="text-muted d-block mt-2">
            {{ _('Die Test-Mail wird an die konfigurierte SMTP-Benutzeradresse gesendet.') }}
          </small>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <strong>{{ _('PostgreSQL-Datenbankexport') }}</strong>
        </div>
        <div class="card-body">
          <p class="text-muted">
            {{ _('Erzeugt einen SQL-Dump der aktuellen Datenbank und bietet ihn zum Download an.') }}
          </p>
          <form method="post" action="{{ url_for('admin_tools') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="dump">
            <button type="submit" class="btn btn-primary"
              onclick="return confirm('{{ _('Dump jetzt erzeugen?') }}')">
              <i class="bi bi-download me-1"></i>{{ _('Dump erzeugen & herunterladen') }}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div> {# row #}

</div> {# container #}
{% endblock %}