{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Zahlungsfreigabe</h2>

  <!-- Aktionen -->
  <div class="d-flex flex-wrap gap-2 mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#antragModal">
      <i class="bi bi-plus-lg me-1"></i> Neuer Antrag
    </button>
    <a href="{{ url_for('payment_routes.export_alle_antraege_pdf') }}" class="btn btn-outline-primary">
      <i class="bi bi-filetype-pdf me-1"></i> Alle Anträge als PDF
    </a>
    <a href="{{ url_for('payment_routes.zahlungsfreigabe') }}" class="btn btn-outline-secondary">
      <i class="bi bi-clock-history me-1"></i> Audit-Übersicht
    </a>
  </div>

  <!-- Tabelle -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Antragsteller/in</th>
          <th>Datum</th>
          <th>Betrag</th>
          <th>Status</th>
          <th class="text-nowrap">Aktionen</th>
        </tr>
      </thead>

      <tbody>
        {% for a in antraege %}
        <tr>
          <td colspan="5">
            <div class="mb-2">
              <strong>Freigabe-Fortschritt:</strong>
              {{ a.freigaben_count }} von {{ a.freigaben_gesamt }} freigegeben
              {% if a.approved_by_me %}
              • <i class="bi bi-person-check text-success"></i> von dir
              {% endif %}
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar" role="progressbar" style="width: {{ a.freigabe_prozent }}%;"
                aria-valuenow="{{ a.freigaben_count }}" aria-valuemin="0" aria-valuemax="{{ a.freigaben_gesamt }}">
                {{ a.freigaben_count }} / {{ a.freigaben_gesamt }}
              </div>
            </div>

          </td>
        </tr>

        <tr>
          <td>{{ a.antragsteller }}</td>
          <td>{{ a.datum }}</td>
          <td>{{ a.betrag }} €</td>
          <td>
            <span class="badge badge-status-{{ a.status|replace(' ', '_') }}">{{ a.status }}</span>
          </td>
          <td class="text-nowrap">

            <!-- Details -->
            <a href="{{ url_for('payment_routes.zahlungsfreigabe_detail', antrag_id=a.id) }}"
              class="btn btn-sm btn-outline-secondary">
              Details
            </a>

            {% if a.can_freigeben %}
            <form method="post" action="{{ url_for('payment_routes.freigeben_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-success">Freigeben</button>
            </form>
            {% endif %}

            {% if a.can_freigabe_zurueckziehen %}
            <form method="post" action="{{ url_for('payment_routes.freigabe_zurueckziehen', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-warning">Freigabe zurückziehen</button>
            </form>
            {% endif %}

            <!--{% if a.can_on_hold %}
            <form method="post" action="{{ url_for('payment_routes.on_hold_antrag', antrag_id=a.id) }}" style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-warning">On hold</button>
            </form>
            {% endif %}

            {% if has_endpoint('fortsetzen_antrag') and a.can_fortsetzen %}
            <form method="post" action="{{ url_for('payment_routes.fortsetzen_antrag', antrag_id=a.id) }}" style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-primary">Fortsetzen</button>
            </form>
            {% endif %}-->
            {% if a.can_on_hold %}
            <form method="post" action="{{ url_for('payment_routes.on_hold_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-warning">On Hold</button>
            </form>
            {% endif %}

            {% if a.can_fortsetzen %}
            <form method="post" action="{{ url_for('payment_routes.fortsetzen_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-primary">Fortsetzen</button>
            </form>
            {% endif %}


            {% if a.can_abschliessen %}
            <form method="post" action="{{ url_for('payment_routes.abschliessen_antrag', antrag_id=a.id) }}"
              style="display:inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-primary">Abschließen</button>
            </form>
            {% endif %}

            {% if a.can_ablehnen %}
            <!-- Einfaches Inline-Ablehnen mit Grund -->
            <form method="post" action="{{ url_for('payment_routes.ablehnen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('Ablehnen?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="grund" value="Abgelehnt (kurzbegründet)">
              <!-- ersetze bei Bedarf durch Modal -->
              <button class="btn btn-sm btn-outline-danger">Ablehnen</button>
            </form>
            {% endif %}

            {% if a.can_zurueckziehen %}
            <form method="post" action="{{ url_for('payment_routes.zurueckziehen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('Antrag zurückziehen?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary">Zurückziehen</button>
            </form>
            {% endif %}

            {% if a.can_loeschen and a.status not in ['abgeschlossen', 'abgelehnt', 'freigegeben'] %}
            <form method="post" action="{{ url_for('payment_routes.loeschen_antrag', antrag_id=a.id) }}"
              style="display:inline" onsubmit="return confirm('Antrag endgültig löschen?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-danger">Löschen</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Ablehnen -->
<div class="modal fade" id="ablehnenModal" tabindex="-1" aria-labelledby="ablehnenModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="ablehnenForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ablehnenModalLabel">Antrag ablehnen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-3">
            <label class="form-label">Begründung (Pflicht)</label>
            <textarea class="form-control" name="grund" required rows="4"
              placeholder="Bitte Ablehnungsgrund angeben."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Abbrechen</button>
          <button class="btn btn-danger" type="submit">Ablehnen</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const ablehnenModal = document.getElementById('ablehnenModal');
  ablehnenModal.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget;
    const antragId = button.getAttribute('data-antrag-id');
    const form = document.getElementById('ablehnenForm');
    form.action = "{{ url_for('payment_routes.ablehnen_antrag', antrag_id=0) }}".replace('/0', '/' + antragId);
  });
</script>

<!-- Modal: Neuer Antrag -->
<div class="modal fade" id="antragModal" tabindex="-1" aria-labelledby="antragModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('payment_routes.zahlungsfreigabe_antrag') }}" id="antragForm"
      class="needs-validation" novalidate>
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="antragModalLabel">Neuen Zahlungsantrag erstellen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-3">
            <label class="form-label">Paragraph (optional)</label>
            <input type="text" name="paragraph" class="form-control" placeholder="z. B. 3a" value="$ 14 Abs. 2">
          </div>

          <div class="mb-3">
            <label class="form-label">Verwendungszweck</label>
            <input type="text" name="zweck" class="form-control" placeholder="Wofür ist die Zahlung?">
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Datum</label>              
              <input type="date" name="datum" class="form-control" required value="{{ today.strftime('%Y-%m-%d') }}">

              <div class="invalid-feedback">Bitte ein Datum angeben.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Betrag</label>
              <div class="input-group">
                <input type="text" name="betrag" class="form-control" inputmode="decimal" placeholder="z. B. 49,90"
                  required>
                <span class="input-group-text">EUR</span>
                <div class="invalid-feedback">Bitte einen Betrag angeben.</div>
              </div>
              <small class="form-text text-muted">Komma oder Punkt als Dezimaltrenner ist möglich.</small>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label">Lieferant (optional)</label>
            <input type="text" name="lieferant" class="form-control" placeholder="Firma / Händler">
          </div>

          <div class="mb-3">
            <label class="form-label">Begründung (optional)</label>
            <textarea name="begruendung" rows="3" class="form-control"
              placeholder="Weshalb ist die Zahlung notwendig?"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Abbrechen</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-check-lg me-1"></i> Anlegen
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  // Bootstrap-Client-Validation aktivieren (optional)
  (() => {
    const form = document.getElementById('antragForm');
    form?.addEventListener('submit', (e) => {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  })();

  // Formular beim Schließen zurücksetzen (optional)
  document.getElementById('antragModal')?.addEventListener('hidden.bs.modal', () => {
    const form = document.getElementById('antragForm');
    if (form) {
      form.reset();
      form.classList.remove('was-validated');
    }
  });
</script>

{% endblock %}