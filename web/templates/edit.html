{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div style="margin: 20px 0;">
          <form method="post" action="/send_attendance_to_chiefs">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="entry_id" value="{{ entry.id }}">
            <button type="submit" class="btn btn-warning" style="font-weight: bold;">
              Anwesenheitsliste versenden
            </button>
          </form>
        </div>
        <h1 class="h5 mb-3">{{ _('Datensatz bearbeiten') }}</h1>

        <form action="{{ url_for('bbalance_routes.edit_post', entry_id=data.id) }}" class="row g-3"
          id="transaction-form" method="post" novalidate="">
          <input name="csrf_token" type="hidden" value="{{ csrf_token() }}" />
          <!-- Datum -->
          <div class="form-floating mb-3">
            <input autofocus="" class="form-control" id="datum" name="datum" placeholder="Datum" required="" type="text"
              value="{{ data.datum.strftime('%d.%m.%Y') if data.datum else '' }}" />
            <label for="datum">{{ _('Datum') }}</label>
          </div>
          <div class="form-floating mb-3">
            <input class="form-control" id="titel" maxlength="500" name="titel" placeholder="{{ _('Titel') }}"
              value="{{ data.titel or '' }}" />
            <label for="titel">{{ _('Titel') }}</label>
          </div>
          <div class="form-floating mb-3">
            <input class="form-control" id="bemerkung" maxlength="500" name="bemerkung"
              placeholder="{{ _('Bemerkung') }}" value="{{ data.bemerkung or '' }}" />
            <label for="bemerkung">{{ _('Bemerkung') }}</label>
          </div>

          <!-- Anwesenheit Jugendliche -->
        <h5 class="mt-4">Anwesenheit – Jugendliche</h5>
<table class="table table-sm table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Mitglied</th>
      <th>Einheit</th>
      <th class="text-center">A</th>
      <th class="text-center">E</th>
      <th class="text-center">U</th>
      <th>Bemerkung</th>
    </tr>
  </thead>
  <tbody>
    {% for u in jugendliche %}
    <tr>
      <td>{{ u.displayname }}</td>
      <td>{{ u.unit }}</td>
      <td class="text-center">
        <input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_A" {% if u.anwesend %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_E" {% if u.entschuldigt %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_U" {% if u.unentschuldigt %}checked{% endif %}>
      </td>
      <td>
        <input type="text" name="bemerkung_{{ u.id }}" class="form-control" value="{{ u.bemerkung or '' }}">
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

          <!-- Anwesenheit Interessenten -->
<h5 class="mt-5">Anwesenheit – Interessenten</h5>
  <table class="table table-sm table-bordered align-middle" id="interessenten-table">
    <thead class="table-light">
      <tr>
        <th>Name</th>
        <th>Einheit</th>
        <th class="text-center">A</th>
        <th class="text-center">E</th>
        <th class="text-center">U</th>
        <th>Bemerkung</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for item in (data.interessenten or []) %}
      {% set i = loop.index0 %}
      <tr>
        <td><input type="text" name="interessent_name_{{ i }}" value="{{ item.name }}" class="form-control"></td>
        <td>
          <select name="interessent_unit_{{ i }}" class="form-select">
                    {% set einheiten = ['Hückelhoven','Ratheim','Hilfarth','Brachelen','Baal','Doveren','Kleingladbach','Schaufenberg'] %}
            {% for einheit in einheiten %}
              <option value="{{ einheit }}" {% if item.loescheinheit == einheit %}selected{% endif %}>{{ einheit }}</option>
            {% endfor %}
          </select>
        </td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_{{ i }}" name="interessent_a_{{ i }}" {% if item.a %}checked{% endif %}></td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_{{ i }}" name="interessent_e_{{ i }}" {% if item.e %}checked{% endif %}></td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_{{ i }}" name="interessent_u_{{ i }}" {% if item.u %}checked{% endif %}></td>
        <td><input type="text" name="interessent_bemerkung_{{ i }}" value="{{ item.bemerkung }}" class="form-control"></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-row">✖</button></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
<button type="button" class="btn btn-sm btn-outline-primary" id="add-interessent">+ Interessent hinzufügen</button>

          <!-- Anwesenheit Betreuer -->
<h5 class="mt-5">Anwesenheit – Betreuer</h5>
<table class="table table-sm table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Mitglied</th>
      <th>Einheit</th>
      <th class="text-center">A</th>
      <th class="text-center">E</th>
      <th class="text-center">U</th>
      <th>Bemerkung</th>
    </tr>
  </thead>
  <tbody>
    {% for u in betreuer %}
    <tr>
      <td>{{ u.displayname }}</td>
      <td>{{ u.unit }}</td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_A" {% if u.anwesend %}checked{% endif %}></td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_E" {% if u.entschuldigt %}checked{% endif %}></td>
                <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="{{ u.id }}" name="anwesenheit_{{ u.id }}_U" {% if u.unentschuldigt %}checked{% endif %}></td>
                <td><input class="form-control" name="bemerkung_{{ u.id }}" type="text" value="{{ u.bemerkung or '' }}"></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="col-12 d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{{ url_for('bbalance_routes.index') }}">{{ _('Abbrechen') }}</a>
            <button class="btn btn-primary" form="transaction-form">{{ _('Speichern') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  function enforceSingleSelection(container) {
    container.addEventListener('change', function(e) {
      if (e.target.classList.contains('anwesenheit') && e.target.checked) {
        const userId = e.target.dataset.user;
        container.querySelectorAll('.anwesenheit[data-user="' + userId + '"]').forEach(function(cb) {
          if (cb !== e.target) cb.checked = false;
        });
      }
    });
  }
  enforceSingleSelection(document);

  const tableBody = document.querySelector('#interessenten-table tbody');
  const addBtn = document.getElementById('add-interessent');
  let index = {{ (data.interessenten|length) if data.interessenten else 0 }};
  const einheiten = ['Hückelhoven','Ratheim','Hilfarth','Brachelen','Baal','Doveren','Kleingladbach','Schaufenberg'];

  function createEinheitDropdown(name) {
    return '<select name="' + name + '" class="form-select">' +
      einheiten.map(e => '<option value="' + e + '">' + e + '</option>').join('') +
      '</select>';
  }

  if (addBtn && tableBody) {
    addBtn.addEventListener('click', () => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" name="interessent_name_${index}" class="form-control"></td>
        <td>${createEinheitDropdown("interessent_unit_" + index)}</td>
        <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_${index}" name="interessent_a_${index}"></td>
        <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_${index}" name="interessent_e_${index}"></td>
        <td class="text-center"><input type="checkbox" class="anwesenheit form-check-input" data-user="interessent_${index}" name="interessent_u_${index}"></td>
        <td><input type="text" name="interessent_bemerkung_${index}" class="form-control"></td>
        <td><button type="button" class="btn btn-sm btn-danger remove-row">✖</button></td>
      `;
      tableBody.appendChild(row);
      index++;
    });

    tableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-row')) {
        e.target.closest('tr').remove();
      }
    });
  }
});
</script>
{% endblock %}
