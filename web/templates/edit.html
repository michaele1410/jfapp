{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h5 mb-3">{{ _('Datensatz bearbeiten') }}</h1>

        <form method="post" action="{{ url_for('bbalance_routes.edit_post', entry_id=data.id) }}" class="row g-3"
          id="transaction-form" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <!-- Datum -->
          <div class="form-floating mb-3">
            <input type="text" name="datum" id="datum" class="form-control" placeholder="Datum"
            value="{{ data.datum.strftime('%d.%m.%Y') if data.datum else '' }}"
            required autofocus>
            <label for="datum">{{ _('Datum') }}</label>
          </div>

          <div class="form-floating mb-3">
            <input id="titel" name="titel" class="form-control" maxlength="500" placeholder="{{ _('Titel') }}"
              value="{{ data.titel or '' }}">
            <label for="Titel">{{ _('Titel') }}</label>
          </div>

          <!-- Vollgut -->
          <!--div class="form-floating mb-3">
            <input id="vollgut" name="vollgut" type="number" inputmode="numeric" min="0" step="1" class="form-control"
              placeholder="0" autocomplete="off" value="{{ data.vollgut if data.vollgut is not none else '' }}">
            <label for="vollgut">{{ _('Vollgut') }}</label>
          </div-->

          <!-- Leergut -->
          <!--div class="form-floating mb-3">
            <input id="leergut" name="leergut" type="number" inputmode="numeric" min="0" step="1" class="form-control"
              placeholder="0" autocomplete="off" value="{{ data.leergut if data.leergut is not none else '' }}">
            <label for="leergut">{{ _('Leergut') }}</label>
          </div-->

          <!-- Einnahme -->
          <!--div class="input-group mb-3">
            <span class="input-group-text">{{ _('waehrung') }}</span>
            <div class="form-floating flex-grow-1">
              <input name="einnahme" id="einnahme" type="number" step="0.01" inputmode="decimal" class="form-control"
                placeholder="0.00" autocomplete="off"
                value="{{ (data.einnahme|replace(',', '.') if data.einnahme is string else ('%.2f'|format(data.einnahme))) if data.einnahme is not none else '' }}">
              <label for="einnahme">{{ _('Einnahme') }}</label>
            </div>
          </div-->

          <!-- Ausgabe -->
          <!--div class="input-group mb-3">
            <span class="input-group-text">{{ _('waehrung') }}</span>
            <div class="form-floating flex-grow-1">
              <input name="ausgabe" id="ausgabe" type="number" step="0.01" inputmode="decimal" class="form-control"
                placeholder="0.00" autocomplete="off"
                value="{{ (data.ausgabe|replace(',', '.') if data.ausgabe is string else ('%.2f'|format(data.ausgabe))) if data.ausgabe is not none else '' }}">
              <label for="ausgabe">{{ _('Ausgabe') }}</label>
            </div>
          </div-->

          <!-- Bemerkung -->
          <div class="form-floating mb-3">
            <input id="bemerkung" name="bemerkung" class="form-control" maxlength="500" placeholder="{{ _('Bemerkung') }}"
              value="{{ data.bemerkung or '' }}">
            <label for="bemerkung">{{ _('Bemerkung') }}</label>
          </div>
          <!-- Bemerkung als Dropdown -->
          <!--div class="form-floating mb-3">
          <select id="bemerkung" name="bemerkung" class="form-select">
            {% set found = false %}
            {% for option in bemerkungsoptionen %}
              {% if data.bemerkung == option %}
                {% set found = true %}
              {% endif %}
              <option value="{{ option }}" {% if data.bemerkung == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
            {% if data.bemerkung and not found %}
              <option value="{{ data.bemerkung }}" selected>{{ data.bemerkung }}</option>
            {% endif %}
          </select-->
          <!--label for="bemerkung">{{ _('Bemerkung') }}</label-->
        
        <h5 class="mt-4">Anwesenheit – Jugendliche</h5>
<table class="table table-sm table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Mitglied</th>
      <th>Einheit</th>
      <th class="text-center">A</th>
      <th class="text-center">E</th>
      <th class="text-center">U</th>
      <th>Bemerkung</th>
    </tr>
  </thead>
  <tbody>
    {% for u in jugendliche %}
    <tr>
      <td>{{ u.username }}</td>
      <td>{{ u.unit }}</td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_A" {% if u.anwesend %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_E" {% if u.entschuldigt %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_U" {% if u.unentschuldigt %}checked{% endif %}>
      </td>
      <td>
        <input type="text" name="bemerkung_{{ u.id }}" class="form-control" value="{{ u.bemerkung or '' }}">
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h5 class="mt-5">Anwesenheit – Betreuer</h5>
<table class="table table-sm table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>Mitglied</th>
      <th>Einheit</th>
      <th class="text-center">A</th>
      <th class="text-center">E</th>
      <th class="text-center">U</th>
      <th>Bemerkung</th>
    </tr>
  </thead>
  <tbody>
    {% for u in betreuer %}
    <tr>
      <td>{{ u.username }}</td>
      <td>{{ u.unit }}</td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_A" {% if u.anwesend %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_E" {% if u.entschuldigt %}checked{% endif %}>
      </td>
      <td class="text-center">
        <input type="checkbox" name="anwesenheit_{{ u.id }}_U" {% if u.unentschuldigt %}checked{% endif %}>
      </td>
      <td>
        <input type="text" name="bemerkung_{{ u.id }}" class="form-control" value="{{ u.bemerkung or '' }}">
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
        </div>

          <div class="col-12 d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{{ url_for('bbalance_routes.index') }}">{{ _('Abbrechen') }}</a>
            <button class="btn btn-primary">{{ _('Speichern') }}</button>
          </div>
        </form>

        <!--hr class="my-4">
        <h3 class="h6 mb-3">{{ _('Anhänge') }}</h3>

        <form action="{{ url_for('attachments_routes.attachments_upload', entry_id=data.id) }}" method="post"
          enctype="multipart/form-data" class="mb-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="input-group">
            <input class="form-control" type="file" name="files" multiple
              accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.heic,.heif,.svg,.txt,.csv,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.xml,.json">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi-upload me-1"></i> {{ _('Hochladen') }}
            </button>
          </div>
          <div class="form-text">
            {{ _('Zulässige Formate:') }} PDF, Bilder, Office, Text. {{ _('Mehrere Dateien möglich.') }}
          </div>
        </form>

        <div class="list-group mb-3" id="editAttachmentsList">
          {% if attachments %}
          {% for att in attachments %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div class="text-truncate" style="max-width: 70%;">
              <i class="bi bi-paperclip me-1"></i>
              <a href="{{ att.url }}" target="_blank">{{ att.name }}</a>
              <small class="text-muted">({{ att.size }} Bytes)</small>
              <a href="{{ att.view_url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ansehen</a>
            </div>
            <form method="post" action="{{ url_for('attachments_routes.attachments_delete', att_id=att.id) }}"
              onsubmit="return confirm('{{ _('Anhang wirklich löschen?') }}');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">{{ _('Löschen') }}</button>
            </form>
          </div>
          {% endfor %}
          {% else %}
          <div class="list-group-item text-muted">{{ _('Keine Anhänge vorhanden.') }}</div>
          {% endif %}
        </div>
        <h5 class="mt-5">Audit-Historie</h5>
        <table class="table table-sm table-striped align-middle">
          <thead>
            <tr>
              <th>Zeitpunkt</th>
              <th>Aktion</th>
              <th>Benutzer</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for a in audit %}
            <tr>
              <td>{{ a.created_at.strftime('%d.%m.%Y %H:%M:%S') if a.created_at else '' }}</td>
              <td>{{ a.action }}</td>
              <td>{{ a.username or 'Unbekannt' }}</td>
              <td>{{ (a.detail or '')|replace('\n', '<br>')|safe }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div-->
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    function isDark() {
      return document.documentElement.getAttribute('data-bs-theme') === 'dark';
    }
    function toggleCalendarDark(calEl, dark) {
      if (!calEl) return;
      calEl.classList.toggle('flatpickr-dark', !!dark);
    }
    if (window.flatpickr) {
      if (flatpickr.l10ns?.de) flatpickr.localize(flatpickr.l10ns.de);
      const fp = flatpickr('#datum', {
        allowInput: true,
        dateFormat: 'd.m.Y',
        clickOpens: true,
        disableMobile: false,
        onOpen: (selectedDates, dateStr, instance) => {
          toggleCalendarDark(instance.calendarContainer, isDark());
        }
      });
      const themeObserver = new MutationObserver(() => {
        const dark = isDark();
        document.querySelectorAll('.flatpickr-calendar').forEach(c => toggleCalendarDark(c, dark));
      });
      themeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
    }

    const form = document.getElementById('transaction-form');
    if (form) {
      form.addEventListener('submit', (event) => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const entryId = {{ data.id }};
  const listGroup = document.getElementById('editAttachmentsList');
  try {
    const resp = await fetch(`/attachments/${entryId}/list`);
    const attachments = await resp.json();

    listGroup.innerHTML = '';

    if (!attachments || attachments.length === 0) {
      listGroup.innerHTML = `<div class="list-group-item text-muted">Keine Anhänge vorhanden.</div>`;
      return;
    }

    attachments.forEach(att => {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';

      const deleteUrl = `/attachments/${att.id}/delete`;

      item.innerHTML = `
        <div class="text-truncate" style="max-width: 70%;">
          <i class="bi bi-paperclip me-1"></i>
          <a href="${att.url}" target="_blank">${att.name}</a>
          <small class="text-muted">(${att.size} Bytes)</small>
          <a href="${att.view_url}" target="_blank" class="btn btn-sm btn-outline-primary">Ansehen</a>
        </div>
        <form method="post" action="${deleteUrl}" onsubmit="return confirm('Anhang wirklich löschen?');">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-sm btn-outline-danger">Löschen</button>
        </form>
      `;

      listGroup.appendChild(item);
    });
  } catch (e) {
    console.error('Fehler beim Laden der Anhänge:', e);
    listGroup.innerHTML = `<div class="list-group-item text-danger">Fehler beim Laden der Anhänge.</div>`;
  }
});
</script>
{% endblock %}