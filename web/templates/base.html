<!doctype html>
<html lang="de" data-bs-theme="{{ theme_preference|default('system') }}">
<head>
  <meta charset="utf-8">
  <title>{{ _('BottleBalanceTitle') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
  <link rel="alternate icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <meta name="color-scheme" content="light dark">
  <script>
  (() => {
    const stored = localStorage.getItem('theme') || '{{ theme_preference|default("system") }}';
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)');
    const effective = stored === 'system' ? (systemDark.matches ? 'dark' : 'light') : stored;
    document.documentElement.setAttribute('data-bs-theme', effective);
  })();
  </script>
</head>
<body>

  <!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
  <div class="container">
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="{{ url_for('bbalance_routes.index') }}">
      <span class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Logo" class="logo-img">
      </span>
    </a>

    {% if session.get('user_id') %}
    <!-- Burger Toggle -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
            aria-controls="navbarContent" aria-expanded="false" aria-label="Menü öffnen">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible Content -->
    <div class="collapse navbar-collapse" id="navbarContent">
      <div class="ms-auto d-flex flex-column flex-lg-row gap-2 mt-3 mt-lg-0">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('bbalance_routes.index') }}">
          <i class="bi-house me-1"></i> {{ _('Dienste') }}
        </a>

        <!--{% if 'users:manage' in (ROLES.get(session.get('role'), [])) %}-->
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('user_routes.users_list') }}">
          <i class="bi-people me-1"></i> {{ _('Mitglieder') }}
        </a>
        <!--{% endif %}-->

        <!--{% if 'audit:view' in (ROLES.get(session.get('role'), set())) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('audit_list') }}">
          <i class="bi-shield-check me-1"></i> {{ _('Audit') }}
        </a>
        {% endif %}-->

        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('profile') }}">
          <i class="bi-person-gear me-1"></i> {{ _('Profil') }}
        </a>

        <!--{% if 'users:manage' in (ROLES.get(session.get('role'), [])) %}
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_tools') }}">
          <i class="bi-tools me-1"></i> {{ _('Admin-Werkzeuge') }}
        </a>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('payment_routes.zahlungsfreigabe') }}">
          <i class="bi-tools me-1"></i> {{ _('Antrag stellen') }}
        </a>
        {% endif %}-->

        <form method="post" action="{{ url_for('auth_routes.logout') }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi-box-arrow-right me-1"></i> {{ _('Logout') }}
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</nav>

  <!-- Main -->
<main class="container my-4">

  {% if current_user() and current_user().get('role') == 'admin' and current_user().get('must_change_password') %}
    <div class="alert alert-warning">
      {{ _('Admin-Passwort noch nicht geändert.') }}
      <a href="{{ url_for('profile') }}" class="alert-link">{{ _('Bitte im Profil aktualisieren.') }}</a>
    </div>
  {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message|safe }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}


  {% block content %}{% endblock %}
</main>

  
<!-- Footer -->
<footer class="border-top py-3">
  <div class="container text-muted small">
    © <a href="mailto:webmaster@michaeleitdorf.de" class="link-secondary text-decoration-none">Michael Eitdorf</a>
  </div>
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/de.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  function applyTheme(mode) {
    const effective = mode === 'system' ? (mq.matches ? 'dark' : 'light') : mode;
    localStorage.setItem('theme', mode);
    document.documentElement.setAttribute('data-bs-theme', effective);
  }
  document.querySelectorAll('input[name="theme"]').forEach(radio => {
    radio.addEventListener('change', e => applyTheme(e.target.value));
  });
  mq.addEventListener('change', () => {
    if ((localStorage.getItem('theme') || '{{ theme_preference|default("system") }}') === 'system') {
      applyTheme('system');
    }
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Flatpickr für Datum
    if (document.querySelector('#datum')) {
  flatpickr("#datum", {
    dateFormat: "d.m.Y",
    locale: "de"
  });
    }

  // Haptisches Feedback für iOS
  function hapticFeedback() {
    if (navigator.vibrate) navigator.vibrate(10);
  }
  document.querySelectorAll('#transaction-form input').forEach(el => {
    el.addEventListener('focus', hapticFeedback);
  });
});
</script>
{% endblock %}
</body>
</html>